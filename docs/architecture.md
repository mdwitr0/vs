# Архитектура проекта
В этом файле описана структура сервисов, их задачи и способы взаимодействия. [Дизайн системы](design.mmd)

## Микросервисы

### Indexer
Сервис для сканирования пиратских сайтов и индексации страниц с видео контентом.
Основной сервис системы, отвечает за обнаружение нарушений.

Сервис должен уметь определять технологии сайта (CMS, SSR/CSR, наличие капчи) и выбирать оптимальную стратегию сканирования.
Для SPA-сайтов используется headless browser (chromedp), для SSR - обычный HTTP клиент.

**Принцип работы:**
- Получает список сайтов для мониторинга через REST API или из базы по расписанию
- Детектирует технологии сайта (DLE, WordPress, SPA, наличие sitemap)
- Сканирует страницы: парсит sitemap.xml или краулит по ссылкам
- Извлекает данные: название, год, внешние ID (kp_id, imdb_id, mal_id), URL плеера
- Сохраняет проиндексированные страницы в MongoDB
- Обновляет статистику по нарушениям
- Работает по расписанию (gocron) с настраиваемыми интервалами для каждого сайта

**Хранимые данные:**
1. **Sites** - список отслеживаемых сайтов с конфигурацией сканирования
2. **Pages** - проиндексированные страницы с извлечёнными данными
3. **ScanTasks** - история и статус задач сканирования (TTL 30 дней)

**API:**
- CRUD для сайтов (добавление, импорт CSV, настройка)
- Запуск сканирования (ручной и batch)
- Получение статуса задач
- Отчёты по нарушениям

---

### Search
Сервис для парсинга поисковой выдачи. Находит новые пиратские сайты через Yandex/Google API.

**В текущей итерации не нужен.**

**Планируемая функциональность:**
- Интеграция с Yandex Search API (основной) и Google Custom Search API
- Формирование запросов вида "<название> смотреть онлайн"
- Фильтрация результатов через whitelist легальных доменов
- Автоматическое добавление найденных доменов в Indexer
- Rate limiting и квотирование запросов к API

**Принцип работы:**
- Получает запрос на поиск (название фильма, поисковая система)
- Выполняет поиск через API
- Фильтрует результаты: исключает домены из whitelist
- Новые домены отправляет в Indexer через REST API
- Сохраняет историю запросов

**Хранимые данные:**
1. **Whitelist** - домены легальных сервисов (kinopoisk.ru, ivi.ru и т.д.)
2. **SearchTasks** - история поисковых запросов

---

### Licenses
Сервис для отслеживания лицензий. Получает информацию о лицензиях через webhook от poiskkino.dev.

**В текущей итерации не нужен.**

**Планируемая функциональность:**
- Webhook endpoint для получения обновлений лицензий
- Валидация входящих данных
- Хранение информации о лицензиях (платформы, сроки)
- Интеграция с Indexer: при появлении лицензии на контент - отметка в базе

**Принцип работы:**
- Получает webhook от poiskkino.dev при изменении лицензий
- Обновляет данные о лицензиях в коллекции Content
- При новой лицензии проверяет наличие контента в индексе Indexer

**Хранимые данные:**
1. **Content** - отслеживаемый контент с информацией о лицензиях и нарушениях

---

### Frontend
SPA приложение для управления системой. React + Vite + shadcn/ui.

**Основные страницы:**
1. **Управление сайтами** - таблица сайтов, фильтры, импорт CSV, запуск сканирования
2. **Управление контентом** - таблица контента, отчёты по нарушениям, экспорт

**Взаимодействие:**
- REST API к каждому сервису напрямую (без API Gateway)
- Polling для отслеживания прогресса сканирования

---

## Потоки данных

### Сканирование сайта (основной flow):
```
Frontend/Scheduler → Indexer API → Detector → Scanner → MongoDB
                                      ↓
                              [chromedp если SPA]
                                      ↓
                              External Site
```

### Поиск новых сайтов (будущее):
```
Frontend → Search API → Yandex/Google API
                ↓
          Whitelist filter
                ↓
          Indexer API (добавление сайта)
```

### Обновление лицензий (будущее):
```
poiskkino.dev → [webhook] → Licenses → MongoDB (Content)
                                          ↓
                                    Indexer (матчинг pages ↔ content)
```

### Характеристики взаимодействия:
- Все сервисы общаются через REST API (синхронно)
- Каждый сервис имеет свою базу/коллекции в MongoDB
- Frontend обращается к сервисам напрямую (Indexer :8080, Search :8081, Licenses :8082)
- Внутри Indexer асинхронная обработка через горутины + gocron для расписания

---

## Технологии
- **MongoDB** для всех данных (sites, pages, content, tasks)
- **Golang** последней версии - основной язык бэкенда
- **Fiber** - HTTP фреймворк
- **Resty** - HTTP клиент для внешних запросов
- **zerolog** - структурированное логирование
- **gocron** - планировщик задач
- **chromedp** - headless browser для SPA-сайтов
- **goquery** - парсинг HTML
- **React + Vite + shadcn/ui** - фронтенд
- **Docker Compose** - деплой

Подробнее о библиотеках и code style: [Code Style](code-style.md)
Структура проекта: [Монорепозиторий](monorepo.md)
