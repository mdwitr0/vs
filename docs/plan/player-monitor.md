## Сервис мониторинга наличия плеера на сайтах

### Обзор

Отдельный сервис для проверки сайтов на наличие видеоплеера. Парсинг через HTTP (с вайтлистом), без капчи. Включает авторизацию с ролевой моделью.

**Переиспользование из текущего проекта:**
- Структура Go-сервиса (indexer как шаблон)
- MongoDB репозитории (паттерны)
- React + shadcn/ui компоненты
- Docker-compose конфигурация

---

### 1. Авторизация и ролевая модель

#### 1.1 Backend: JWT авторизация

**Задачи:**
- Регистрация и логин по логину/паролю
- JWT токены (access + refresh)
- Middleware для проверки авторизации
- Хеширование паролей (bcrypt)

**Структура данных (MongoDB):**
```json
{
  "_id": "ObjectId",
  "login": "string",
  "password_hash": "string",
  "role": "enum(admin, user)",
  "is_active": "bool",
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```

**Endpoints:**
- `POST /api/auth/login` - авторизация
- `POST /api/auth/refresh` - обновление токена
- `POST /api/auth/logout` - выход

**Переиспользование:** Структура handler/usecase/repo из indexer

**Оценка:** 4 часа

#### 1.2 Backend: Управление пользователями (Admin)

**Задачи:**
- CRUD операции для пользователей
- Проверка роли admin в middleware
- Активация/деактивация пользователей

**Endpoints:**
- `GET /api/users` - список пользователей (admin)
- `POST /api/users` - создание пользователя (admin)
- `PUT /api/users/:id` - редактирование (admin)
- `DELETE /api/users/:id` - удаление (admin)
- `PATCH /api/users/:id/status` - активация/деактивация (admin)

**Оценка:** 2 часа

#### 1.3 Frontend: Авторизация

**Задачи:**
- Страница логина
- Хранение токена (localStorage/httpOnly cookie)
- Protected routes
- Контекст авторизации

**Переиспользование:** shadcn/ui компоненты, структура проекта

**Оценка:** 2 часа

#### 1.4 Frontend: Управление пользователями

**Задачи:**
- Таблица пользователей
- Модалки создания/редактирования
- Переключатель активации
- Смена роли

**Переиспользование:** Таблица из текущего фронтенда

**Оценка:** 2 часа

---

### 2. Парсер сайтов

#### 2.1 HTTP парсер

**Задачи:**
- HTTP клиент с retry и таймаутами
- Извлечение всех ссылок со страницы
- Поиск iframe/embed плеера по настраиваемому паттерну
- Обработка robots.txt (опционально)

**Особенности:**
- Вайтлист IP для обхода блокировок
- Rate limiting на уровне домена
- User-Agent ротация

**Переиспользование:** HTTP клиент из pkg/, парсер уже есть

**Оценка:** 3 часа

#### 2.2 Краулер страниц

**Задачи:**
- Парсинг sitemap.xml
- Рекурсивный обход ссылок (с глубиной)
- Очередь URL для обработки
- Дедупликация URL

**Переиспользование:** Краулер из parser

**Оценка:** 2 часа

#### 2.3 Детектор типа страницы

**Задачи:**
- Определение страниц-каталогов (списки, категории)
- Определение 404 и ошибок
- Определение статических страниц (about, contacts)
- Маркировка страниц для исключения из отчетов

**Эвристики:**
- Анализ URL паттернов (/category/, /page/, /tag/)
- Проверка meta robots
- Анализ количества ссылок на странице
- HTTP статус коды

**Оценка:** 2 часа

---

### 3. Основной сервис (Indexer)

#### 3.1 Хранилище данных

**Структура Site (MongoDB):**
```json
{
  "_id": "ObjectId",
  "domain": "string",
  "total_pages": "int",
  "pages_with_player": "int",
  "pages_without_player": "int",
  "last_scan_at": "timestamp",
  "status": "enum(active, scanning, error)",
  "created_at": "timestamp"
}
```

**Структура Page (MongoDB):**
```json
{
  "_id": "ObjectId",
  "site_id": "ObjectId",
  "url": "string",
  "has_player": "bool",
  "page_type": "enum(content, catalog, static, error)",
  "exclude_from_report": "bool",
  "last_checked_at": "timestamp"
}
```

**Индексы:**
- site_id + has_player для быстрой фильтрации
- url для дедупликации
- page_type для фильтрации отчетов

**Переиспользование:** Паттерны репозиториев из indexer

**Оценка:** 2 часа

#### 3.2 API для сайтов

**Endpoints:**
- `GET /api/sites` - список сайтов с фильтрацией и пагинацией
- `POST /api/sites` - добавление сайта
- `POST /api/sites/import` - импорт из CSV
- `POST /api/sites/:id/scan` - запуск сканирования
- `GET /api/sites/:id` - детали сайта
- `GET /api/sites/:id/pages` - страницы сайта с фильтрами
- `GET /api/sites/:id/export` - экспорт страниц без плеера (CSV)

**Переиспользование:** Структура handlers из indexer

**Оценка:** 3 часа

#### 3.3 Шедулер автоматического обхода

**Задачи:**
- Периодический запуск по настраиваемому интервалу
- Очередь сайтов для сканирования
- Контроль параллельных задач
- Логирование результатов

**Переиспользование:** gocron паттерн из текущего проекта

**Оценка:** 1 час

---

### 4. Админ-панель

#### 4.1 Backend: Настройки системы

**Структура Settings (MongoDB):**
```json
{
  "_id": "ObjectId",
  "player_pattern": "string",
  "scan_interval_hours": "int",
  "updated_at": "timestamp",
  "updated_by": "ObjectId"
}
```

**Endpoints:**
- `GET /api/settings` - получение настроек
- `PUT /api/settings` - обновление настроек (admin)

**Оценка:** 1 час

#### 4.2 Frontend: Страница настроек

**Задачи:**
- Форма редактирования паттерна плеера
- Настройка частоты обхода
- Валидация regex паттерна

**Оценка:** 1 час

---

### 5. Логирование действий

#### 5.1 Backend: Аудит лог

**Структура AuditLog (MongoDB):**
```json
{
  "_id": "ObjectId",
  "user_id": "ObjectId",
  "action": "enum(domain_upload, settings_change, report_export, user_create, user_update)",
  "details": "object",
  "ip_address": "string",
  "created_at": "timestamp"
}
```

**Задачи:**
- Middleware для записи действий
- Логирование в MongoDB
- API для просмотра логов (admin)

**Endpoints:**
- `GET /api/audit-logs` - список логов с фильтрацией (admin)

**Новый функционал** (нет в текущем проекте)

**Оценка:** 4 часа

---

### 6. Frontend: Основной интерфейс

#### 6.1 Список сайтов

**Задачи:**
- Таблица сайтов с колонками: домен, дата обхода, страниц всего, страниц без плеера
- Фильтры: дата обхода, наличие страниц без плеера
- Поиск по домену
- Кнопка запуска сканирования
- Импорт CSV

**Переиспользование:** DataTable, фильтры из текущего фронта

**Оценка:** 2 часа

#### 6.2 Детальная страница сайта

**Задачи:**
- Статистика сайта
- Таблица страниц с фильтрами (с плеером/без, тип страницы)
- Кнопка исключения страницы из отчета
- Экспорт в CSV

**Переиспользование:** Компоненты таблиц

**Оценка:** 1 час

#### 6.3 Навигация и layout

**Задачи:**
- Sidebar с разделами (Сайты, Пользователи, Настройки, Логи)
- Условное отображение admin-разделов
- Header с информацией о пользователе

**Переиспользование:** Layout из текущего проекта

**Оценка:** 1 час

---

### 7. Инфраструктура

#### 7.1 Docker и деплой

**Задачи:**
- Dockerfile для сервиса
- docker-compose конфигурация
- Nginx конфиг для фронтенда
- Переменные окружения

**Переиспользование:** Текущие Docker файлы

**Оценка:** 1 час

---

## Сводка по времени

*С учетом переиспользования готового кода из текущего проекта*

| Модуль | Часы | Что делаем |
|--------|------|------------|
| 1.1 JWT авторизация | 4 | Добавить middleware, login endpoint |
| 1.2 Управление пользователями (BE) | 2 | CRUD по шаблону существующих handlers |
| 1.3 Авторизация (FE) | 2 | Страница логина, контекст auth |
| 1.4 Управление пользователями (FE) | 2 | Таблица + модалки (копия существующих) |
| 2.1 HTTP парсер | 3 | Адаптация существующего, убрать браузер |
| 2.2 Краулер страниц | 2 | Sitemap + рекурсия уже есть |
| 2.3 Детектор типа страницы | 2 | Простые эвристики по URL |
| 3.1 Хранилище данных | 2 | Новые модели по существующему шаблону |
| 3.2 API для сайтов | 3 | Адаптация существующих endpoints |
| 3.3 Шедулер | 1 | gocron уже настроен |
| 4.1-4.2 Настройки | 2 | Простая форма + endpoint |
| 5.1 Аудит лог | 4 | Новый функционал: middleware + repo + UI |
| 6.1-6.2 Frontend сайты | 3 | Адаптация существующих таблиц |
| 6.3 Layout | 1 | Копия с новым меню |
| 7.1 Docker | 1 | Копия конфигов |

**Итого:** ~34 часа

---

## Риски

1. **Блокировка со стороны сайтов** — митигация через вайтлист и rate limiting
2. **Неточное определение типа страницы** — потребуется донастройка эвристик
3. **Большое количество страниц на сайте** — нужна пагинация и ограничение глубины обхода

## Порядок разработки (рекомендуемый)

1. Инфраструктура и базовая структура сервиса
2. Авторизация (backend + frontend)
3. Хранилище данных и API сайтов
4. HTTP парсер и краулер
5. Frontend: список сайтов
6. Детектор типа страницы
7. Шедулер
8. Админ-панель и настройки
9. Управление пользователями
10. Логирование действий
