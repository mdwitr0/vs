%%{init: {'theme': 'base', 'themeVariables': {'primaryColor': '#e0e7ff', 'lineColor': '#6366f1'}}}%%

flowchart LR
    %% ===== ACTORS =====
    USER(("üë§ Manager"))
    CRON(("‚è∞ Scheduler"))

    %% ===== FRONTEND =====
    FE["üñ•Ô∏è <b>Frontend</b><br/>React ¬∑ :3000"]

    %% ===== INDEXER SERVICE =====
    subgraph Indexer["Indexer Service ¬∑ :8080"]
        direction TB

        API["<b>REST API</b><br/>Fiber"]

        subgraph Core["Business Logic"]
            direction LR
            DETECT["<b>Detector</b><br/>–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç CMS,<br/>SSR/CSR, Captcha"]
            SCAN["<b>Scanner</b><br/>Sitemap parser,<br/>Crawler, Extractor"]
        end

        BROWSER["<b>Browser</b><br/>chromedp<br/>–¥–ª—è SPA —Å–∞–π—Ç–æ–≤"]
    end

    %% ===== EXTERNAL =====
    SITES[("üè¥‚Äç‚ò†Ô∏è <b>Pirate Sites</b>")]

    %% ===== DATABASE =====
    subgraph DB["MongoDB"]
        direction TB
        C_SITES[("sites")]
        C_PAGES[("pages")]
        C_TASKS[("scan_tasks")]
    end

    %% ===== FLOW 1: Manual Scan =====
    USER -->|"1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç UI"| FE
    FE -->|"2. POST /sites/{id}/scan"| API
    API -->|"3. –°–æ–∑–¥–∞—ë—Ç task"| C_TASKS
    API -->|"4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç taskId"| FE

    %% ===== FLOW 2: Scheduled Scan =====
    CRON -->|"1. –¢—Ä–∏–≥–≥–µ—Ä –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"| API

    %% ===== FLOW 3: Scan Process =====
    API -->|"5. –ó–∞–ø—É—Å–∫–∞–µ—Ç"| DETECT
    DETECT -->|"6. GET /"| SITES
    DETECT -->|"7. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç tech_info"| C_SITES

    DETECT -->|"8. –ï—Å–ª–∏ SPA"| BROWSER
    BROWSER -->|"9. –†–µ–Ω–¥–µ—Ä–∏—Ç JS"| SITES

    API -->|"10. –ó–∞–ø—É—Å–∫–∞–µ—Ç"| SCAN
    SCAN -->|"11. GET sitemap.xml"| SITES
    SCAN -->|"12. GET /movie/*"| SITES
    SCAN -->|"13. –ï—Å–ª–∏ SPA"| BROWSER

    SCAN -->|"14. Upsert pages"| C_PAGES
    SCAN -->|"15. Update stats"| C_SITES
    SCAN -->|"16. Complete task"| C_TASKS

    %% ===== FLOW 4: Polling =====
    FE -.->|"Poll: GET /tasks/{id}"| API
    API -.->|"Progress/Result"| FE

    %% ===== STYLING =====
    classDef actor fill:#7c3aed,stroke:#5b21b6,color:#fff
    classDef frontend fill:#dbeafe,stroke:#2563eb,color:#1e40af
    classDef service fill:#dcfce7,stroke:#16a34a,color:#166534
    classDef external fill:#fee2e2,stroke:#dc2626,color:#991b1b
    classDef database fill:#fef9c3,stroke:#ca8a04,color:#854d0e
    classDef browser fill:#f3e8ff,stroke:#9333ea,color:#7e22ce

    class USER,CRON actor
    class FE frontend
    class API,DETECT,SCAN,Core service
    class BROWSER browser
    class SITES external
    class DB,C_SITES,C_PAGES,C_TASKS database
